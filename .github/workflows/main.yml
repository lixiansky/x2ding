name: Twitter Monitor

on:
  schedule:
    # 每 10 分钟运行一次 - 标准调度模式,避免延迟累积
    - cron: '*/10 * * * *'
  workflow_dispatch:
    # 允许手动触发

jobs:
  monitor:
    runs-on: ubuntu-latest
    # 单次执行最多 8 分钟
    timeout-minutes: 8
    permissions:
      contents: write  # 允许提交代码(更新 last_id.json)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'  # 缓存 pip 依赖,加速安装

    - name: Cache Playwright browsers
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: playwright-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          playwright-${{ runner.os }}-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        playwright install chromium --with-deps

    - name: Run monitor script (single check)
      env:
        TWITTER_USER: ${{ secrets.TWITTER_USER }}
        DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
        CLOUDFLARE_PROXY: ${{ secrets.CLOUDFLARE_PROXY }}
        LOOP_MODE: 'false'  # 关闭循环模式,每次独立执行
      run: python twitter_monitor.py

    - name: Commit and push if changed
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        git add last_id.json
        
        # 检查是否有变更
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: update last_id.json [skip ci]"
          git push
        fi
